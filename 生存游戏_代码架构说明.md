# 生存游戏 - 代码架构说明

## 📂 代码文件结构

```
Assets/Game/Scripts/
├── Player/                      # 玩家系统
│   ├── PlayerController.cs     # 玩家控制器（移动、交互）
│   ├── PlayerData.cs           # 玩家数据管理（使用Observer）
│   └── PlayerStatsSystem.cs    # 属性系统（饥饿/口渴消耗）
│
├── Resource/                    # 资源系统
│   ├── ResourceObject.cs       # 资源对象（可采集）
│   └── ResourceSpawner.cs      # 资源生成器
│
├── Enemy/                       # 敌人系统
│   ├── EnemyController.cs      # 敌人AI（巡逻、追踪、攻击）
│   └── EnemySpawner.cs         # 敌人生成器
│
├── Manager/                     # 游戏管理
│   └── GameManager.cs          # 游戏总管理器
│
├── UI/                          # 用户界面
│   ├── MainMenuUI.cs           # 主菜单
│   ├── GameHUD.cs              # 游戏HUD
│   └── GameOverUI.cs           # 游戏结束界面
│
└── Launcher.cs                  # 游戏启动器

Generate/Scripts/Configs/         # Excel自动生成
├── ResourceConfigs.cs           # 资源配置类
└── EnemyConfigs.cs             # 敌人配置类
```

---

## 🏗️ 系统架构设计

### 1. 核心管理层（GameManager）

**职责**：
- 统一管理游戏流程（开始、暂停、结束）
- 管理玩家数据
- 加载和缓存配置表
- 协调各个子系统

**关键方法**：
```csharp
public void 开始新游戏()      // 重置数据，启动游戏
public void 继续游戏()         // 从存档继续
public void 暂停游戏()         // 暂停游戏
public void 恢复游戏()         // 恢复游戏
public void 返回主菜单()       // 返回主菜单
public ResourceConfig 获取资源配置(int ID)
public EnemyConfig 获取敌人配置(int ID)
```

**使用的框架模块**：
- `IConfigs` - 配置系统
- `IObservers` - 观察者系统
- `IUI` - UI系统
- `TimerCenter` - 定时器系统

---

### 2. 玩家系统

#### 2.1 PlayerData（数据层）

**职责**：
- 管理玩家所有属性数据
- 使用Observer模式实现数据绑定
- 支持数据持久化（存档）

**核心属性**：
```csharp
public float 生命值 { get; set; }          // 0-100
public float 饥饿值 { get; set; }          // 0-100
public float 口渴值 { get; set; }          // 0-100
public int 木材数量 { get; set; }
public int 石头数量 { get; set; }
public float 生存时间 { get; set; }
```

**观察者访问**：
```csharp
public IValueObserver<float> 生命值观察者
// UI可以监听这些观察者，实现自动更新
```

**使用的框架模块**：
- `IObservers.Cache()` - 缓存型观察者（自动存储）
- `IStorage` - 存储系统（通过Cache观察者）

#### 2.2 PlayerStatsSystem（逻辑层）

**职责**：
- 处理饥饿值和口渴值的持续消耗
- 低属性时扣除生命值
- 记录生存时间

**使用的框架模块**：
- `TimerCenter` - 定时器系统（每秒更新一次）

#### 2.3 PlayerController（表现层）

**职责**：
- 处理玩家输入（WASD移动）
- 实现角色移动（CharacterController）
- 处理交互逻辑（E键采集）

**核心方法**：
```csharp
private void 处理移动()         // WASD移动
private void 处理交互()         // E键交互
private void 检测并交互()       // 射线检测可交互对象
```

---

### 3. 资源系统

#### 3.1 ResourceObject（资源对象）

**职责**：
- 表示一个可采集的资源
- 处理采集进度
- 给予资源奖励

**工作流程**：
```
1. 玩家按E键 → 开始采集
2. 按住E键 → 持续采集（显示进度条）
3. 进度完成 → 给予资源奖励
4. 资源生命值耗尽 → 销毁对象
```

**配置读取**：
```csharp
private ResourceConfig _配置;  // 从GameManager获取
```

#### 3.2 ResourceSpawner（资源生成器）

**职责**：
- 在场景中随机生成资源
- 管理已生成的资源列表

---

### 4. 敌人系统

#### 4.1 EnemyController（敌人AI）

**状态机设计**：
```
巡逻状态 → 检测到玩家 → 追踪状态
追踪状态 → 靠近玩家 → 攻击状态
攻击状态 → 玩家离开 → 追踪状态
追踪状态 → 玩家远离 → 巡逻状态
```

**AI行为**：
- **巡逻**：在初始位置周围随机移动
- **追踪**：向玩家方向移动
- **攻击**：面向玩家，定时攻击

**配置读取**：
```csharp
private EnemyConfig _配置;  // 从GameManager获取
```

#### 4.2 EnemySpawner（敌人生成器）

**职责**：
- 定时在玩家周围生成敌人
- 保持敌人数量不超过上限

**使用的框架模块**：
- `TimerCenter` - 定时器系统

---

### 5. UI系统

所有UI继承自框架的 `UIBehaviour` 基类。

#### 5.1 MainMenuUI（主菜单）

**功能**：
- 开始新游戏
- 继续游戏（检查存档）
- 退出游戏

#### 5.2 GameHUD（游戏HUD）

**数据绑定**：
```csharp
// 监听玩家数据变化
玩家数据.生命值观察者.OnChange.Add(更新生命值显示);
玩家数据.饥饿值观察者.OnChange.Add(更新饥饿值显示);
// ... 其他属性
```

**特点**：
- 使用Observer模式实现数据驱动UI
- 数据变化自动更新显示

#### 5.3 GameOverUI（游戏结束）

**功能**：
- 显示生存时间和收集统计
- 重新开始游戏
- 返回主菜单

---

## 🔄 数据流转示意

### 采集资源流程

```
1. 玩家按E键
   ↓
2. PlayerController.检测并交互()
   ↓
3. ResourceObject.开始采集()
   ↓
4. 持续采集（Update中检测）
   ↓
5. ResourceObject.完成采集()
   ↓
6. GameManager.玩家数据.添加资源()
   ↓
7. Observer触发OnChange事件
   ↓
8. GameHUD自动更新显示
```

### 玩家受伤流程

```
1. EnemyController.攻击玩家()
   ↓
2. GameManager.玩家数据.受到伤害()
   ↓
3. PlayerData修改生命值
   ↓
4. Observer触发OnChange事件
   ↓
5. GameHUD自动更新生命值显示
   ↓
6. 如果生命值≤0
   ↓
7. GameManager.玩家死亡()
   ↓
8. 显示GameOverUI
```

### 饥饿/口渴消耗流程

```
1. PlayerStatsSystem.启动()
   ↓
2. TimerCenter每秒触发定时器
   ↓
3. PlayerStatsSystem减少饥饿/口渴值
   ↓
4. 如果值≤0，扣除生命值
   ↓
5. Observer触发OnChange
   ↓
6. GameHUD自动更新显示
```

---

## 🎯 框架模块应用实例

### 1. UI系统 (IUI)

**使用位置**：
- `GameManager` - 显示/隐藏UI
- `MainMenuUI` - 调用Hide()方法

**代码示例**：
```csharp
// 显示UI
GridFramework.UI.Show<GameHUD>();

// 隐藏UI
GridFramework.UI.Hide<MainMenuUI>();

// 在UI内部隐藏自己
Hide();
```

### 2. Observer系统 (IObservers)

**使用位置**：
- `PlayerData` - 所有属性使用Observer
- `GameHUD` - 监听数据变化

**代码示例**：
```csharp
// 创建观察者
_生命值 = GridFramework.Observer.Cache("玩家_生命值", 100f);

// 监听变化
玩家数据.生命值观察者.OnChange.Add((新值, 旧值) => {
    // 自动更新UI
});
```

### 3. Config系统 (IConfigs)

**使用位置**：
- `GameManager` - 加载Excel配置

**代码示例**：
```csharp
// 获取配置
var 资源配置 = GridFramework.Config.Get<ResourceConfigs>();

// 访问数据
foreach (var 配置 in 资源配置.Value)
{
    // 处理配置
}
```

### 4. Timer系统 (TimerCenter)

**使用位置**：
- `PlayerStatsSystem` - 属性消耗定时器
- `EnemySpawner` - 敌人生成定时器

**代码示例**：
```csharp
// 添加定时器
GridFramework.Timer.AddTimer("定时器ID", 1f, () => {
    // 每秒执行
}, true); // true表示重复执行

// 暂停定时器
GridFramework.Timer.PauseTimer("定时器ID");

// 移除定时器
GridFramework.Timer.RemoveTimer("定时器ID");
```

### 5. Storage系统 (IStorage)

**使用位置**：
- `PlayerData` - 通过Cache观察者自动存储

**代码示例**：
```csharp
// 检查存档
bool 有存档 = GridFramework.Storage.Exists("玩家_生命值");

// 清除存档
GridFramework.Storage.Remove("玩家_生命值");
```

---

## 💡 设计模式应用

### 1. 单例模式
- `GameManager.实例` - 全局唯一实例

### 2. 观察者模式
- `PlayerData` + `GameHUD` - 数据变化驱动UI更新

### 3. 状态机模式
- `EnemyController` - 敌人AI状态切换

### 4. 对象池模式（预留）
- 可以使用框架的 `PoolModule` 优化资源和敌人生成

---

## 🔧 扩展点

### 1. 添加新资源类型
1. 在Excel中添加新行
2. 创建对应预制体
3. 设置正确的资源ID
4. 添加到ResourceSpawner列表

### 2. 添加新敌人类型
1. 在Excel中添加新行
2. 创建对应预制体
3. 设置正确的敌人ID
4. 添加到EnemySpawner列表

### 3. 添加新UI界面
1. 创建继承自 `UIBehaviour` 的新类
2. 创建对应预制体
3. 使用 `GridFramework.UI.Show<T>()` 显示

### 4. 添加音效
```csharp
// 使用框架的Sound模块
GridFramework.Sound.PlayEffect("采集音效");
GridFramework.Sound.PlayMusic("背景音乐");
```

---

## 📊 性能优化建议

1. **对象池**：使用框架的PoolModule管理频繁创建/销毁的对象
2. **层级管理**：合理设置Layer，减少射线检测开销
3. **配置缓存**：GameManager已实现配置字典缓存
4. **Update优化**：将频繁操作改为定时器或事件驱动

---

## 🎓 学习要点

通过这个项目，你可以学习到：

1. ✅ 如何使用框架的核心系统（UI、Observer、Config、Timer、Storage）
2. ✅ Excel配置表的设计和导出流程
3. ✅ 观察者模式实现数据驱动UI
4. ✅ 简单AI状态机的实现
5. ✅ 游戏架构的分层设计
6. ✅ Unity基础功能（移动、碰撞、射线检测）

---

## 📚 相关文档

- [生存游戏_操作指南.md](生存游戏_操作指南.md) - 详细的配置和搭建步骤
- [Excel配置表说明.md](Excel配置表说明.md) - Excel格式说明
- [Framework/README.md](Assets/Framework/README.md) - 框架使用文档

---

祝你学习愉快！如有问题，请查看代码注释或参考框架文档。🎮

